#!/bin/sh
# ^ Changed to sh for compatibility

# --- The "Anti-Bloat" Verification ---
# System Audit: Detect node_modules in the stage
STAGED_MODULES=$(git diff --cached --name-only | grep "node_modules/" || true)

if [ -n "$STAGED_MODULES" ]; then
  echo "‚ùå [SYSTEM AUDIT FAILURE]: node_modules detected in commit!"
  echo "Manual Rewind Required: Run 'git rm -r --cached node_modules' to purge."
  exit 1
fi

# Check for empty files in staged changes
echo "üìÇ Checking for empty files in staged changes..."

# We use a subshell and pipe (POSIX compliant) instead of '<<<' (Bash only)
EMPTY_FILES=$(git diff --cached --name-only --diff-filter=AM | while IFS= read -r file; do
  # Skip blank lines
  [ -z "$file" ] && continue

  # Check allow-list using 'case' (works in all shells)
  case "$file" in
    *.gitkeep|*.keep|*/.gitkeep|*/.keep) continue ;;
  esac

  # Integrity Check: verify file exists (-f) and is empty (! -s)
  if [ -f "$file" ] && [ ! -s "$file" ]; then
    echo "$file"
  fi
done)

if [ -n "$EMPTY_FILES" ]; then
  echo "üõë [SYSTEM AUDIT FAILURE]: Empty files detected!"
  echo "$EMPTY_FILES"
  exit 1
fi

# Step 4: Markdown lint (docs integrity)
echo "üìù [STEP 4]: Auditing documentation (markdownlint)..."
# Using 'command -v' check is safer than blindly running npx if it might be missing,
# but your original logic is fine if npx is guaranteed.
if ! npx --no-install markdownlint . --ignore node_modules; then
  echo "üõë [DOCS FAULT]: Markdown lint failed."
  echo "   Run: npm run lint:md:fix"
  exit 1
fi
echo "‚úÖ [STEP 4]: Docs are clean."

# Lint and format staged files
echo "üîç Running lint-staged (prettier + eslint + markdownlint) on staged files..."
npx lint-staged

echo "‚úÖ Integrity verified. Proceeding with commit."
