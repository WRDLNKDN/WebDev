#!/bin/sh

# --- 1. The "Anti-Bloat" Verification ---
# System Audit: Detect node_modules in the stage
STAGED_MODULES=$(git diff --cached --name-only | grep "node_modules/" || true)

if [ -n "$STAGED_MODULES" ]; then
  echo "âŒ [SYSTEM AUDIT FAILURE]: node_modules detected in commit!"
  echo "Manual Rewind Required: Run 'git rm -r --cached node_modules' to purge."
  exit 1
fi

# --- 2. Empty File Check ---
echo "ðŸ“‚ [STEP 2]: Checking for empty files..."

# Use temp file so 'while read' runs in main shell (avoids case/;; parsing in pipe subshell)
tmp=$(mktemp)
trap 'rm -f "$tmp"' EXIT
git diff --cached --name-only --diff-filter=AM > "$tmp"
EMPTY_FILES=""
while IFS= read -r file; do
  [ -z "$file" ] && continue
  # Skip allow-listed empty files
  case "$file" in *.gitkeep) continue ;; esac
  case "$file" in *.keep) continue ;; esac
  case "$file" in */.gitkeep) continue ;; esac
  case "$file" in */.keep) continue ;; esac
  [ -f "$file" ] && [ ! -s "$file" ] && EMPTY_FILES="${EMPTY_FILES}${file}
"
done < "$tmp"

if [ -n "$EMPTY_FILES" ]; then
  echo "ðŸ›‘ [SYSTEM AUDIT FAILURE]: Empty files detected!"
  echo "$EMPTY_FILES"
  exit 1
fi
echo "âœ… [STEP 2]: No empty files found."

# --- 3. Type Checking (The Missing Piece) ---
echo "ðŸ—ï¸ [STEP 3]: Validating Types (TypeScript)..."
# We run the command you defined in package.json
if ! npm run typecheck; then
  echo "ðŸ›‘ [TYPE ERROR]: TypeScript compilation failed."
  echo "   Fix the errors above or run 'npm run typecheck' to debug."
  exit 1
fi
echo "âœ… [STEP 3]: Types are valid."

# --- 4. Lint Staged Files (fix first, then we verify) ---
echo "ðŸ” [STEP 4]: Running lint-staged (prettier, eslint, markdownlint --fix)..."
npx lint-staged
# lint-staged runs markdownlint --fix on staged .md files so fixable issues
# are applied before we run the full markdown check below.

# --- 5. Markdown Lint (full repo check) ---
echo "ðŸ“ [STEP 5]: Auditing documentation (markdownlint)..."
if ! npm run lint:md; then
  echo "ðŸ›‘ [DOCS FAULT]: Markdown lint failed."
  echo "   Run: npm run lint:md:fix (fixes only rules that support --fix)."
  echo "   See docs/development/markdownlint.md for why some issues need manual fixes."
  exit 1
fi
echo "âœ… [STEP 5]: Docs are clean."

echo "âœ… Integrity verified. Proceeding with commit."
