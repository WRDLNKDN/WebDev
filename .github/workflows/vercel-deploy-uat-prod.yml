name: Deploy UAT then PROD

on:
  push:
    branches: [main]

  workflow_dispatch:
    inputs:
      deploy_prod:
        description: Deploy production
        required: false
        type: boolean
        default: false

jobs:
  deploy-uat:
    name: Deploy UAT
    runs-on: ubuntu-latest
    environment: uat

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v5
        with:
          node-version: 22

      - run: npm ci

      # --- Supabase (UAT) ---
      - run: npx supabase@latest login --token "${{ secrets.SUPABASE_ACCESS_TOKEN }}" --no-browser
      - run: npx supabase@latest link --project-ref "${{ secrets.SUPABASE_UAT_PROJECT_REF }}"
      - run: npx supabase@latest db push

      # --- Vercel (UAT) ---
      - name: Deploy UAT to Vercel
        run: |
          npx vercel@latest deploy \
            --prod \
            --yes \
            --token "${{ secrets.VERCEL_TOKEN }}" \
            --scope "${{ secrets.VERCEL_SCOPE }}" \
            --name webdev-uat

  deploy-prod:
    name: Deploy PROD
    runs-on: ubuntu-latest
    needs: deploy-uat
    environment: production
    if: github.event_name == 'push' || inputs.deploy_prod

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v5
        with:
          node-version: 22

      - run: npm ci

      # --- Supabase (PROD) ---
      - run: npx supabase@latest login --token "${{ secrets.SUPABASE_ACCESS_TOKEN }}" --no-browser
      - run: npx supabase@latest link --project-ref "${{ secrets.SUPABASE_PROD_PROJECT_REF }}"
      - run: npx supabase@latest db push

      # --- Vercel (PROD) ---
      - name: Deploy PROD to Vercel
        run: |
          npx vercel@latest deploy \
            --prod \
            --yes \
            --token "${{ secrets.VERCEL_TOKEN }}" \
            --scope "${{ secrets.VERCEL_SCOPE }}" \
            --name wrdlnkdn