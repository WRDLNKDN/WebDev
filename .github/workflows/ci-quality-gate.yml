name: CI ‚Äì Quality Gate

on:
  pull_request:
    branches: [main]

  # Optional manual run (for e2e UI mode, or ad-hoc)
  workflow_dispatch:
    inputs:
      run_e2e_ui:
        description: 'Run Playwright UI mode (interactive). Not for normal CI.'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

concurrency:
  group: WebDev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  webdev:
    name: ‚úÖ WebDev CI (Quality + Unit + E2E)
    runs-on: ubuntu-latest

    env:
      # Safe dummy values for build/test where needed
      VITE_SUPABASE_URL: 'https://example.supabase.co'
      VITE_SUPABASE_ANON_KEY: 'dummy-anon-key-for-ci'
      E2E_PORT: '5173'

      # If you still need this for react-helmet-async peer deps resolution
      NPM_CONFIG_LEGACY_PEER_DEPS: 'true'

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v5

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: npm

      - name: üì¶ Install dependencies
        run: npm ci

      # -----------------------
      # Quality + Unit (Vitest)
      # -----------------------
      - name: üßπ ESLint
        id: lint
        continue-on-error: true
        run: npm run lint

      - name: üß™ TypeScript typecheck
        id: typecheck
        continue-on-error: true
        run: npm run typecheck

      - name: üé® Prettier check
        id: format
        continue-on-error: true
        run: npm run format:check

      - name: üß´ Markdown lint
        id: mdlint
        continue-on-error: true
        run: npm run lint:md

      - name: üß™ Vitest (unit)
        id: unit
        continue-on-error: true
        run: npm run test:unit

      # -------------
      # E2E (Playwright)
      # -------------
      - name: üé≠ Install Playwright Browsers
        id: pwinstall
        continue-on-error: true
        run: npx playwright install --with-deps chromium

      - name: üé≠ Run Playwright tests (E2E)
        id: e2e
        continue-on-error: true
        run: npm run test:e2e

      - name: üìé Upload Playwright report (on failure)
        if: steps.e2e.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7

      # Optional: UI mode (manual only, run locally ‚Äî no display in CI)
      - name: üé≠ Playwright UI mode (manual only, local use)
        if:
          github.event_name == 'workflow_dispatch' && inputs.run_e2e_ui ==
          'true' && env.CI != 'true'
        env:
          CI: ${{ env.CI }}
        run:
          echo "Skipping Playwright UI in CI (no display). Run npm run
          test:e2e:ui locally."

      # -----------------------
      # Summary gate (single status)
      # -----------------------
      - name: WebDevExpected (summary gate)
        if: always()
        run: |
          echo "lint:      ${{ steps.lint.outcome }}"
          echo "typecheck: ${{ steps.typecheck.outcome }}"
          echo "format:    ${{ steps.format.outcome }}"
          echo "mdlint:    ${{ steps.mdlint.outcome }}"
          echo "unit:      ${{ steps.unit.outcome }}"
          echo "pwinstall: ${{ steps.pwinstall.outcome }}"
          echo "e2e:       ${{ steps.e2e.outcome }}"

          fail=0
          [ "${{ steps.lint.outcome }}" = "success" ] || fail=1
          [ "${{ steps.typecheck.outcome }}" = "success" ] || fail=1
          [ "${{ steps.format.outcome }}" = "success" ] || fail=1
          [ "${{ steps.mdlint.outcome }}" = "success" ] || fail=1
          [ "${{ steps.unit.outcome }}" = "success" ] || fail=1
          [ "${{ steps.pwinstall.outcome }}" = "success" ] || fail=1
          [ "${{ steps.e2e.outcome }}" = "success" ] || fail=1

          if [ "$fail" -ne 0 ]; then
            echo ""
            echo "‚ùå CI quality gate failed"
            exit 1
          fi

          echo ""
          echo "‚úÖ CI quality gate passed"
